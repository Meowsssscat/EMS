{% extends "admin_layout.html" %}

{% block title %}Attendance Management - EMS{% endblock %}
 {% block extra_styles %}<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_attendance.css') }}">{% endblock %}

{% block content %}


 
<!-- Attendance Statistics -->
<div class="stats-section">
    <div class="stat-card present">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-number" id="presentCount">{{ stats.present or 0 }}</span>
            <span class="stat-label">Present Today</span>
        </div>
    </div>
    
    <div class="stat-card absent">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-number" id="absentCount">{{ stats.absent or 0 }}</span>
            <span class="stat-label">Absent Today</span>
        </div>
    </div>
    
    <div class="stat-card late">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-number" id="lateCount">{{ stats.late or 0 }}</span>
            <span class="stat-label">Late Today</span>
        </div>
    </div>
    
    <div class="stat-card not-marked">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4"/>
                <path d="M12 16h.01"/>
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-number" id="notMarkedCount">{{ stats.not_marked or 0 }}</span>
            <span class="stat-label">Not Marked</span>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="content-grid">
    <!-- Quick Actions Section -->
    <div class="section-card">
        <div class="section-header">
            <h2>Quick Mark Attendance</h2>
            <span class="date-display">{{ today.strftime('%B %d, %Y') }}</span>
        </div>
        <div class="section-content">
            <form id="quickMarkForm" class="quick-mark-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeSelect">Select Employee</label>
                        <select id="employeeSelect" name="employee_id" required>
                            <option value="">Choose an employee...</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}">
                                {{ employee.name }} - {{ employee.department }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="statusSelect">Status</label>
                        <select id="statusSelect" name="status" required>
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="attendanceDate">Date</label>
                        <input type="date" id="attendanceDate" name="date" value="{{ today }}" max="{{ today }}" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22,4 12,14.01 9,11.01"/>
                    </svg>
                    Mark Attendance
                </button>
            </form>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="section-card">
        <div class="section-header">
            <h2>Filter Attendance Records</h2>
            <button id="clearFiltersBtn" class="btn btn-ghost btn-sm">Clear Filters</button>
        </div>
        <div class="section-content">
            <form id="filterForm" class="filter-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterEmployee">Employee</label>
                        <select id="filterEmployee" name="employee_id">
                            <option value="">All Employees</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}">{{ employee.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterStatus">Status</label>
                        <select id="filterStatus" name="status">
                            <option value="">All Status</option>
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" name="start_date">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" name="end_date">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-secondary">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Apply Filters
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Attendance Records Section -->
<div class="section-card">
    <div class="section-header">
        <h2>Attendance Records</h2>
        <div class="header-actions">
            <span id="recordCount" class="record-count">{{ attendance_data|length }} records</span>
            <button id="exportBtn" class="btn btn-ghost btn-sm">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </button>
        </div>
    </div>
    
    <div class="table-container" id="attendanceTableContainer">
        <div class="table-wrapper">
            <table class="attendance-table" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Marked At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    {% for record in attendance_data %}
                    <tr data-id="{{ record.id if record.id else '' }}">
                        <td>
                            <span class="date-badge">
                                {{ record.date.strftime('%m/%d/%Y') if record.date else '' }}
                            </span>
                        </td>
                        <td>
                            <div class="employee-info">
                                <span class="employee-name">{{ record.name }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="department-badge">{{ record.department }}</span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ record.status }}">
                                {{ record.status|capitalize }}
                            </span>
                        </td>
                        <td>
                            <span class="time-badge">
                                {{ record.created_at.strftime('%I:%M %p') if record.created_at else 'N/A' }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon-only edit-btn" data-id="{{ record.id if record.id else '' }}" title="Edit">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                </button>
                                <button class="btn-icon-only delete-btn" data-id="{{ record.id if record.id else '' }}" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
            <h3>No Attendance Records Found</h3>
            <p>No attendance records match your current filters. Try adjusting your search criteria.</p>
        </div>
    </div>
</div>

<!-- Bulk Mark Modal -->
<div id="bulkMarkModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Bulk Mark Attendance</h3>
            <button class="modal-close" id="closeBulkModal">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="bulkMarkForm">
                <div class="form-group">
                    <label for="bulkDate">Date</label>
                    <input type="date" id="bulkDate" name="date" value="{{ today }}" max="{{ today }}" required>
                </div>
                
                <div class="form-group">
                    <label for="bulkStatus">Status</label>
                    <select id="bulkStatus" name="status" required>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Select Employees</label>
                    <div class="employee-selection">
                        <div class="selection-header">
                            <label class="checkbox-container">
                                <input type="checkbox" id="selectAllEmployees">
                                <span class="checkmark"></span>
                                Select All
                            </label>
                            <span class="selected-count">0 selected</span>
                        </div>
                        
                        <div class="employee-list" id="bulkEmployeeList">
                            {% for employee in employees %}
                            <label class="employee-item checkbox-container">
                                <input type="checkbox" name="employee_ids" value="{{ employee.id }}">
                                <span class="checkmark"></span>
                                <div class="employee-details">
                                    <span class="employee-name">{{ employee.name }}</span>
                                    <span class="employee-dept">{{ employee.department }}</span>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" id="cancelBulkMark">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                        Mark Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Attendance Report</h3>
            <button class="modal-close" id="closeReportModal">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="reportForm" class="report-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportStartDate">Start Date</label>
                        <input type="date" id="reportStartDate" name="start_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportEndDate">End Date</label>
                        <input type="date" id="reportEndDate" name="end_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportEmployee">Employee (Optional)</label>
                        <select id="reportEmployee" name="employee_id">
                            <option value="">All Employees</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}">{{ employee.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                        </svg>
                        Generate Report
                    </button>
                </div>
            </form>
            
            <div id="reportResults" class="report-results" style="display: none;">
                <div class="report-header">
                    <h4>Attendance Report</h4>
                    <button id="downloadReport" class="btn btn-secondary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download CSV
                    </button>
                </div>
                
                <div class="report-summary" id="reportSummary"></div>
                
                <div class="report-table-container">
                    <table class="report-table" id="reportTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Present Days</th>
                                <th>Absent Days</th>
                                <th>Late Days</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
    <div class="toast-content">
        <span class="toast-message"></span>
        <button class="toast-close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>
</div>



{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_attendance.js') }}"></script>
{% endblock %}